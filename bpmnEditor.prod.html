<!-- 
    This is an automatically generated production version of index.html
    All local CSS and JavaScript files have been inlined
    Generated on: 2025-03-12T12:18:27.441Z
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BPMN.io Editor</title>
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAAsTAAALEwEAmpwYAAAF0WlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNy4yLWMwMDAgNzkuMWI2NWE3OWI0LCAyMDIyLzA2LzEzLTIyOjAxOjAxICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdEV2dD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlRXZlbnQjIiB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iIHhtbG5zOnBob3Rvc2hvcD0iaHR0cDovL25zLmFkb2JlLmNvbS9waG90b3Nob3AvMS4wLyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgMjQuMCAoV2luZG93cykiIHhtcDpDcmVhdGVEYXRlPSIyMDI0LTAzLTIwVDEyOjQ3OjA2KzAxOjAwIiB4bXA6TWV0YWRhdGFEYXRlPSIyMDI0LTAzLTIwVDEyOjQ3OjA2KzAxOjAwIiB4bXA6TW9kaWZ5RGF0ZT0iMjAyNC0wMy0yMFQxMjo0NzowNiswMTowMCIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDo5ZDFiZjM4Yy1mZDY5LTRlNDItODY0ZC1mODEwZjE0ZjQ5ZjAiIHhtcE1NOkRvY3VtZW50SUQ9ImFkb2JlOmRvY2lkOnBob3Rvc2hvcDo5ZDFiZjM4Yy1mZDY5LTRlNDItODY0ZC1mODEwZjE0ZjQ5ZjAiIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo5ZDFiZjM4Yy1mZDY5LTRlNDItODY0ZC1mODEwZjE0ZjQ5ZjAiIGRjOmZvcm1hdD0iaW1hZ2UvcG5nIiBwaG90b3Nob3A6Q29sb3JNb2RlPSIzIj4gPHhtcE1NOkhpc3Rvcnk+IDxyZGY6U2VxPiA8cmRmOmxpIHN0RXZ0OmFjdGlvbj0iY3JlYXRlZCIgc3RFdnQ6aW5zdGFuY2VJRD0ieG1wLmlpZDo5ZDFiZjM4Yy1mZDY5LTRlNDItODY0ZC1mODEwZjE0ZjQ5ZjAiIHN0RXZ0OndoZW49IjIwMjQtMDMtMjBUMTI6NDc6MDYrMDE6MDAiIHN0RXZ0OnNvZnR3YXJlQWdlbnQ9IkFkb2JlIFBob3Rvc2hvcCAyNC4wIChXaW5kb3dzKSIvPiA8L3JkZjpTZXE+IDwveG1wTU06SGlzdG9yeT4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz7tB7p9AAAFaklEQVRYhe2XW2xUVRSGv7X3mTM9M522tEML0wK9QAu0EC4FjDeUaAwGQzQYjYkxPqgxPuIDDz754oMaDL4QH4wJGmOMiZgYidGIGo0JIqgUi1wKLQXaQm2n7Uw7c2bO2csHCgSYtkNJfNCVnOx9dvb6/7P+vfZeR1SVWxnhVqK7DXDPAVz/N8AyPQURQUR4eWiAIW8PJWUJIokk/f39NDfU0tq0m3vvqGSuOk3PwAi5fJ5UOo3f5yMYDNLQUM/g8Bi1NdXEYjECgQDhcJjc/DzRaJRgKITP58Pv9xMOh5memaGhoZ5UOk0mk8U0TZxCgcbGRgKBAMFgkEgkQi6fZ3h4mEgkQigUYnFxkYaGBgzDYGpqimw2SyqVwjRNstks0WiUYDCIz+fD7/cTCoWYmZ0lFAoRiUQoFArU1dVhqHK7KAGgvLwcEaGrqwvTNPH7/TiOQyQSYceOHZw5c4aqqipEhLm5OSoqKti/fz+GYVBaWsrU1BRer5fOzk7y+TyWZREMBtm5cyciwsDAAD6fj0QiwZ49e8hkMgwNDbF//34Mw6C0tJSpqSlKSkro6OjAcRyi0SjhcBjDMLAsC4/HQzKZxLZt6urqsCyLeDxOPp/HNE1s28ayLPx+P/F4HK/XSzKZxHEcbNvGsiwMw8Dr9WJYlkUqlSKTyRAKhSgrK8OyLPL5PD6fj0QiQTqdJhwOU1FRgWEYzM7OMjs7SzQapby8HBFhbm6O+fl5otEooVAIEWFubo5cLkcoFKKyshIRYXZ2llwuRzgcprKyEhFhZmaGXC5HOBymqqoKEWF6ehrbtvF6vVRXV6OqTE1NYds2Pp+PmpoaVJXJyUmy2SyBQIDa2lpUlYmJCbLZLIFAgLq6OlSV8fFxMpkMgUCA+vp6VJWxsTEymQzBYJCGhgZUldHRUdLpNMFgkMbGRlSVkZERUqkUwWCQpqYmVJXh4WGSySSBQIDm5mZUlaGhIRKJBIFAgJaWFlSVwcFB4vE4fr+f1tZWVJWBgQHi8Th+v5+2tjZUlf7+fmKxGD6fj/b2dlSVvr4+YrEYPp+Pjo4OVJW+vj5isRher5fOzk5UlXPnzjE7O4vX66Wrq4sCcEFVL6mqXrhGLgKjqnoJuKiqF1T1oqpeUtWLqnpJVS+p6kVVvaSql1X1sqpeVtUrqnpFVa+o6mVVvaKql1X1iqpeVdXLqnpZVa+q6lVVvayqV1X1qqpeVdWrqnpVVa+p6jVVvaaq11T1mqpeU9VrqnpdVa+r6nVVva6q11X1uqpeV9XrqnpDVW+o6g1VvaGqN1T1hqreUNWbqnpTVW+q6k1VvamqN1X1pqreVNVbqnpLVW+p6i1VvaWqt1T1lqreUtXbqnpbVW+r6m1Vva2qt1X1tqreVtU7qnpHVe+o6h1VvaOqd1T1jqreUdW7qnpXVe+q6l1VvauqvwE/icgDwBPAV8DHwHvAO8DbwJvA68BrwKvAK8DLwIvAQeAA8DzwHLAPeBbYCzwDPA08BTwJPAE8DjwG7AYeBR4BdgEPA7uAh4CHgAeBB4D7gfuA+4B7gXuAe4DtwHZgG7AV2ApsATYDm4CNwEZgA7Ae6AHWAd3AWqALWAOsBjqBVUAHsBJYASwHlgEdQDuwDGgDWoEWoBlYCjQBjUAD0AjUA3VAPVAHLAHqgVqgFqgBqoEqoBKoAMqBMqAUKAHCQAgIAgEgAPiBEsAHFAMe4P+ZkP8A/N8B/gQYUjN2c1mMxgAAAABJRU5ErkJggg==">
    <!-- BPMN.io dependencies -->
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@9.0.3/dist/assets/diagram-js.css">
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@9.0.3/dist/assets/bpmn-font/css/bpmn.css">
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@9.0.3/dist/assets/bpmn-js.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Local styles -->
    <style>
body {
    margin: 0;
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
}

.title-bar {
    padding: 10px;
    background-color: #f5f5f5;
    border-bottom: 1px solid #ccc;
    display: flex;
    align-items: center;
    gap: 15px;
}

.title-container {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    position: relative;
}

.edit-icon {
    color: #6c757d;
    font-size: 0.9em;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.title-container:hover .edit-icon {
    opacity: 1;
}

.buttons {
    padding: 10px;
    background-color: #f5f5f5;
    border-bottom: 1px solid #ccc;
    display: flex;
}

.buttons .btn-group {
    display: flex;
    gap: 5px;
}

.buttons button {
    display: flex;
    align-items: center;
    gap: 5px;
}

.buttons button i {
    font-size: 1.1em;
}

#save-btn {
    margin-left: 0;
}

.main-container {
    width: 100%;
    height: calc(100vh - 100px); /* Adjust based on your title-bar and buttons height */
    position: relative;
}

#canvas {
    width: calc(100% - 300px);
    height: 100%;
    transition: width 0.3s ease;
}

.bjs-container {
    position: absolute !important;
    width: 100% !important;
    height: 100% !important;
    background-color: white !important;
}

/* Main grid */
.djs-container .viewport {
    position: relative;
}

.djs-container .viewport::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: 
        linear-gradient(#dee2e6 1px, transparent 1px),
        linear-gradient(90deg, #dee2e6 1px, transparent 1px);
    background-size: 30px 30px;
    transform: var(--djs-viewport-transform);
    transform-origin: 0 0;
    pointer-events: none;
}

.djs-container .viewport::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: 
        linear-gradient(#f8f9fa 1px, transparent 1px),
        linear-gradient(90deg, #f8f9fa 1px, transparent 1px);
    background-size: 10px 10px;
    transform: var(--djs-viewport-transform);
    transform-origin: 0 0;
    pointer-events: none;
}

#diagram-title {
    font-size: 1.2em;
    font-weight: bold;
    color: #333;
    padding: 2px 5px;
    border: 1px solid transparent;
    cursor: pointer;
}

#diagram-title:hover {
    background-color: #fff;
    border: 1px solid #ccc;
}

#diagram-title:focus {
    background-color: #fff;
    border: 1px solid #007bff;
    outline: none;
}

#diagram-title:focus + .edit-icon {
    opacity: 0;
}

/* Make the PNG button icon slightly different */
#save-png-btn i {
    transform: scale(0.9); /* Slightly smaller icon to differentiate */
}

/* Add a subtle separator between different export types */
#save-svg-btn {
    border-right: 1px solid #ddd;
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
}

#save-png-btn {
    border-left: 0;
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
}

/* Right Panel Styles */
.right-panel {
    position: absolute;
    right: 0;
    top: 0;
    height: 100%;
    width: 300px;
    background: #f8f9fa;
    border-left: 1px solid #dee2e6;
    box-shadow: -2px 0 5px rgba(0,0,0,0.05);
    transition: transform 0.3s ease, width 0.3s ease;
    transform: translateX(0); /* Start panel visible */
}

.right-panel.collapsed {
    transform: translateX(100%);
}

.panel-toggle {
    position: absolute;
    left: -30px;
    top: 50%;
    transform: translateY(-50%);
    width: 30px;
    height: 60px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-right: none;
    border-radius: 4px 0 0 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
}

.panel-toggle i {
    transform: rotate(0deg);
    transition: transform 0.3s ease;
}

.right-panel.collapsed .panel-toggle i {
    transform: rotate(180deg);
}

.panel-content {
    padding: 1.25rem;
    height: 100%;
    overflow-y: auto;
}

.panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding: 0 0.5rem;
}

.panel-header h4 {
    margin: 0;
    color: #495057;
    font-size: 1.1rem;
    font-weight: 600;
}

.panel-section {
    margin-bottom: 1rem;
    padding: 0.75rem;
    background: #ffffff;
    border-radius: 8px;
    border: 1px solid #e9ecef;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

/* Only apply full width when the collapsed class is present */
#canvas.full-width {
    width: 100%;
}

/* Update the editor container styles */
.editor-container {
    position: relative;
    height: calc(100vh - 200px);
}

#xml-source {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    padding: 1rem;
    font-family: 'Fira Code', 'Consolas', monospace;
    font-size: 13px;
    line-height: 1.5;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    background-color: transparent;
    color: transparent;
    caret-color: #212529;
    resize: none;
    white-space: pre;
    overflow-wrap: normal;
    overflow-x: auto;
    tab-size: 2;
    z-index: 1;
}

.xml-highlighted {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 1rem;
    font-family: 'Fira Code', 'Consolas', monospace;
    font-size: 13px;
    line-height: 1.5;
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    pointer-events: none;
    overflow-y: auto;
    white-space: pre;
    z-index: 0;
}

.xml-highlighted code {
    font-family: inherit;
    background: transparent !important;
    padding: 0 !important;
    white-space: pre;
    display: block;
}

#xml-source:focus {
    outline: none;
}

.editor-container:focus-within .xml-highlighted {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13,110,253,.25);
}

/* Update scrollbar styles to apply to both elements */
.editor-container ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

.editor-container ::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.editor-container ::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

.editor-container ::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Update expand button styles */
.expand-panel {
    padding: 4px 8px;
    color: #6c757d;
    border-color: #dee2e6;
    background-color: transparent;
    transition: all 0.2s ease;
}

.expand-panel:hover {
    color: #495057;
    background-color: #e9ecef;
    border-color: #ced4da;
}

.expand-panel i {
    font-size: 1rem;
}

/* Update right panel styles */
.right-panel {
    /* ... existing position and size styles ... */
    background: #f8f9fa;
    border-left: 1px solid #dee2e6;
    box-shadow: -2px 0 5px rgba(0,0,0,0.05);
}

.panel-content {
    padding: 1.25rem;
    height: 100%;
    overflow-y: auto;
}

/* Add a subtle animation for the expand/collapse */
.right-panel.expanded {
    width: 600px;
    transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Add some syntax highlighting-like styles */
#xml-source {
    /* ... existing styles ... */
    caret-color: #495057;
}

/* Optional: Add a loading state style */
#xml-source.loading {
    opacity: 0.7;
    cursor: wait;
}

.undo-redo-container {
    display: flex;
    gap: 5px;
}

.undo-redo-container button {
    padding: 4px 8px;
}

.undo-redo-container button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.undo-redo-container i {
    font-size: 1.1em;
}

/* Modify the canvas width calculation when panel is expanded */
.right-panel.expanded + #canvas {
    width: calc(100% - 600px);
}

/* Adjust the transition for smooth width changes */
.right-panel {
    /* ... existing styles ... */
    transition: transform 0.3s ease, width 0.3s ease;
}

/* Update button styles to use black */
.btn-outline-secondary,
.btn-outline-primary,
.btn-outline-success,
.btn-outline-info {
    color: #212529 !important;
    border-color: #212529 !important;
}

.btn-outline-secondary:hover,
.btn-outline-primary:hover,
.btn-outline-success:hover,
.btn-outline-info:hover {
    color: #fff !important;
    background-color: #212529 !important;
    border-color: #212529 !important;
}

/* Keep disabled state looking disabled */
.btn:disabled {
    opacity: 0.5;
    color: #6c757d !important;
    border-color: #6c757d !important;
    background-color: transparent !important;
}

/* Preserve the separator line color */
#save-svg-btn {
    border-right-color: #dee2e6;
}

/* Ensure highlight.js styles are visible */
.hljs {
    background: transparent !important;
    padding: 0 !important;
}

.hljs-tag {
    color: #22863a !important;
}

.hljs-name {
    color: #22863a !important;
}

.hljs-attr {
    color: #6f42c1 !important;
}

.hljs-string {
    color: #032f62 !important;
}

/* Add custom color picker icon */
.bpmn-icon-custom-color {
    position: relative;
    display: inline-block;
    width: 100%;
    height: 100%;
}

.bpmn-icon-custom-color::before {
    content: 'ðŸŽ¨';  /* Unicode paint palette emoji */
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    font-size: 14px;
}

/* Style for the context pad entry */
.djs-context-pad .entry.custom-color {
    background: white;
    border-radius: 3px;
}

.djs-context-pad .entry.custom-color:hover {
    background: #f0f0f0;
}

/* Multi-selection panel styles */
#multi-selection-panel {
    padding: 1rem;
}

.multi-selection-actions {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-top: 1rem;
}

.multi-selection-actions button {
    width: 100%;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    justify-content: center;
}

.multi-selection-actions i {
    font-size: 1.1em;
}

/* Zoom controls */
.djs-zoom-controls {
    position: fixed;
    left: 20px;
    bottom: 20px;
    z-index: 100;
}

.zoom-buttons {
    display: flex;
    flex-direction: row;
    gap: 2px;  /* Reduced gap to match palette */
    background: #F8F8F8;  /* Match djs-palette background */
    padding: 5px;  /* Match djs-palette padding */
    border: solid 1px #CCC;  /* Match djs-palette border */
    border-radius: 2px;  /* Match djs-palette border-radius */
    box-shadow: 0 1px 2px rgba(0,0,0,0.2);  /* Match djs-palette shadow */
}

.zoom-buttons button {
    padding: 2px 4px;  /* Match palette entry padding */
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;  /* Match palette entry size */
    height: 24px;
    border-radius: 3px;  /* Match palette entry border-radius */
    transition: all 0.1s ease;
    border: solid 1px transparent;  /* For hover state */
    background: transparent;
}

.zoom-buttons button:hover {
    background: #F8F8F8;  /* Match palette hover */
    border: solid 1px #CCC;  /* Match palette hover border */
    transform: none;  /* Remove previous transform */
    box-shadow: none;  /* Remove previous shadow */
}

.zoom-buttons button i {
    font-size: 1em;  /* Match palette icon size */
    color: #555;  /* Match palette icon color */
}

/* Remove previous button spacing */
.zoom-buttons button + button {
    margin: 0;
}

/* Keyboard shortcuts overlay */
.keyboard-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.keyboard-content {
    background: white;
    border-radius: 8px;
    padding: 20px;
    width: 500px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
}

.keyboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.keyboard-header h4 {
    margin: 0;
}

.shortcuts-list {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.shortcut-group h5 {
    margin-bottom: 10px;
    color: #666;
}

.shortcut-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px 0;
}

.shortcut-keys {
    display: flex;
    gap: 5px;
    align-items: center;
}

kbd {
    color: black;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 3px;
    padding: 2px 6px;
    font-size: 0.9em;
    font-family: 'Fira Code', monospace;
}

.shortcut-desc {
    color: #666;
}

/* Shortcuts toggle button */
.shortcuts-toggle {
    position: fixed;
    right: 20px;
    top: 20px;
    z-index: 100;
}

.shortcuts-toggle button {
    padding: 2px 4px;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    border-radius: 3px;
    transition: all 0.1s ease;
    border: solid 1px #CCC;
    background: #F8F8F8;
    box-shadow: 0 1px 2px rgba(0,0,0,0.2);
}

.shortcuts-toggle button:hover {
    background: #F8F8F8;
    border: solid 1px #999;
}

.shortcuts-toggle button i {
    font-size: 1em;
    color: #555;
}

/* Auto-color toggle styles */
.buttons {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
}

.auto-color-toggle {
    margin-right: 20px;
}

.auto-color-toggle .form-check {
    display: flex;
    align-items: center;
    gap: 5px;
}

.auto-color-toggle .form-check-input {
    margin-top: 0;
}

/* Color picker popup styles */
.djs-popup.color-picker {
    position: fixed;
    background: white;
    border: 1px solid #CCC;
    border-radius: 2px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.3);
    z-index: 1000;
    padding: 6px;
}

.color-options {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 4px;
}

.color-option {
    width: 24px;
    height: 24px;
    border: 1px solid #CCC;
    border-radius: 3px;
    cursor: pointer;
    padding: 0;
    background-clip: padding-box; /* Ensures background doesn't bleed under border */
}

/* Special styling for white color option */
.color-option[data-color="white"] {
    border: 1px solid #DDD;
    background: white;
}

.color-option[data-color="white"]:hover {
    border-color: #999;
}

.color-option:hover {
    transform: scale(1.1);
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.more-colors {
    grid-column: 1 / -1;
    margin-top: 4px;
    padding: 4px;
    background: #f8f9fa;
    border: 1px solid #CCC;
    border-radius: 3px;
    font-size: 12px;
    cursor: pointer;
}

.more-colors:hover {
    background: #e9ecef;
}

/* Remove color option styling */
.color-option.remove-color {
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #666;
}

.color-option.remove-color:hover {
    color: #333;
    background: #f8f9fa;
}

.color-option.remove-color i {
    font-size: 14px;
}

/* Canvas grid styling */
.bjs-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-image: 
        linear-gradient(#f8f9fa 1px, transparent 1px),
        linear-gradient(90deg, #f8f9fa 1px, transparent 1px);
    background-size: 10px 10px;
    background-attachment: fixed;
    pointer-events: none;
} 


</style>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap">
    <!-- Add highlight.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/xml.min.js"></script>
</head>
<body>
    <div class="title-bar">
        <div class="undo-redo-container">
            <button id="undo-btn" class="btn btn-outline-secondary btn-sm" disabled>
                <i class="bi bi-arrow-counterclockwise"></i>
            </button>
            <button id="redo-btn" class="btn btn-outline-secondary btn-sm" disabled>
                <i class="bi bi-arrow-clockwise"></i>
            </button>
        </div>
        <div class="title-container">
            <span id="diagram-title" contenteditable="true" spellcheck="false">Untitled Diagram</span>
            <i class="bi bi-pencil edit-icon"></i>
        </div>
    </div>
    <div class="buttons">
        <div class="btn-group">
            <button id="load-btn" class="btn btn-outline-secondary">
                <i class="bi bi-folder2-open"></i>
                Open
            </button>
            <button id="save-btn" class="btn btn-outline-primary">
                <i class="bi bi-save"></i>
                Save
            </button>
            <button id="save-svg-btn" class="btn btn-outline-success">
                <i class="bi bi-file-earmark-image"></i>
                Export SVG
            </button>
            <button id="save-png-btn" class="btn btn-outline-info" style="border-left: 1px solid black">
                <i class="bi bi-file-earmark-image"></i>
                Export PNG
            </button>
        </div>
        <div class="auto-color-toggle">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="auto-color-toggle">
                <label class="form-check-label" for="auto-color-toggle">
                    Auto-colour
                </label>
            </div>
        </div>
    </div>
    <div class="main-container">
        <div id="canvas">
            <div class="djs-zoom-controls">
                <div class="zoom-buttons">
                    <button class="btn btn-outline-secondary" id="zoom-in" title="Zoom In">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                    <button class="btn btn-outline-secondary" id="zoom-out" title="Zoom Out">
                        <i class="bi bi-dash-lg"></i>
                    </button>
                    <button class="btn btn-outline-secondary" id="zoom-fit" title="Zoom to Fit">
                        <i class="bi bi-arrows-fullscreen"></i>
                    </button>
                </div>
            </div>
            <div class="shortcuts-toggle">
                <button class="btn btn-outline-secondary" id="show-shortcuts" title="Keyboard Shortcuts">
                    <i class="bi bi-keyboard"></i>
                </button>
            </div>
        </div>
        <div class="right-panel">
            <button class="panel-toggle">
                <i class="bi bi-chevron-right"></i>
            </button>
            <div class="panel-content">
                <div class="panel-header">
                    <h4>Source Code</h4>
                    <button class="btn btn-outline-secondary btn-sm expand-panel">
                        <i class="bi bi-arrows-fullscreen"></i>
                    </button>
                </div>
                <div class="panel-section">
                    <div class="editor-container">
                        <textarea id="xml-source" spellcheck="false"></textarea>
                        <pre class="xml-highlighted"><code class="language-xml"></code></pre>
                    </div>
                </div>
            </div>
            <div id="multi-selection-panel" class="panel-content" style="display: none;">
                <h5>Multiple Elements Selected</h5>
                <div class="multi-selection-actions">
                    <button class="btn btn-outline-secondary" id="multi-color-btn">
                        <i class="bi bi-palette"></i>
                        Change Color
                    </button>
                    <button class="btn btn-outline-primary" id="multi-copy-btn">
                        <i class="bi bi-clipboard"></i>
                        Copy
                    </button>
                    <button class="btn btn-outline-success" id="multi-paste-btn">
                        <i class="bi bi-clipboard-plus"></i>
                        Paste
                    </button>
                    <button class="btn btn-outline-danger" id="multi-delete-btn">
                        <i class="bi bi-trash"></i>
                        Delete All
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- BPMN.io dependencies -->
    <script src="https://unpkg.com/bpmn-js@9.0.3/dist/bpmn-navigated-viewer.development.js"></script>
    <script src="https://unpkg.com/bpmn-js@9.0.3/dist/bpmn-modeler.development.js"></script>

    <!-- Local scripts (as modules) -->
    <script>
// Make modeler available globally for other modules
window.modeler = new BpmnJS({
    container: '#canvas',
    canvas: {
        deferUpdate: false
    },
    grid: {
        visible: true
    }
});

// Initialize these variables at the top of your file
let lastFileHandle = null; // Store the file handle for saving back to the same location

// Add this check at the start of your file
const hasFileSystemAccess = 'showOpenFilePicker' in window;

// You can use this to modify the UI or show different tooltips
if (!hasFileSystemAccess) {
    console.log('File System Access API not supported - using download fallback');
}

// Add these at the top of your file, after the modeler initialization
class DiagramState {
    constructor(xml, position) {
        this.xml = xml;
        this.position = position;
    }
}

class DiagramHistory {
    constructor() {
        this.states = [];
        this.currentIndex = -1;
        this.maxStates = 50; // Maximum number of states to keep
    }

    async saveState() {
        try {
            const { xml } = await window.modeler.saveXML({ format: true });
            
            // Remove any future states if we're in the middle of the history
            this.states = this.states.slice(0, this.currentIndex + 1);
            
            // Add new state
            this.states.push(new DiagramState(xml, this.currentIndex + 1));
            
            // Remove oldest state if we exceed maxStates
            if (this.states.length > this.maxStates) {
                this.states.shift();
            }
            
            this.currentIndex = this.states.length - 1;
            
            // Update button states
            this.updateUndoRedoButtons();
        } catch (err) {
            console.error('Error saving diagram state:', err);
        }
    }

    async undo() {
        if (this.currentIndex > 0) {
            this.currentIndex--;
            await this.restoreState();
        }
    }

    async redo() {
        if (this.currentIndex < this.states.length - 1) {
            this.currentIndex++;
            await this.restoreState();
        }
    }

    async restoreState() {
        try {
            const state = this.states[this.currentIndex];
            await window.modeler.importXML(state.xml);
            await updateXMLSource();
            this.updateUndoRedoButtons();
        } catch (err) {
            console.error('Error restoring diagram state:', err);
        }
    }

    updateUndoRedoButtons() {
        const undoButton = document.getElementById('undo-btn');
        const redoButton = document.getElementById('redo-btn');
        
        undoButton.disabled = this.currentIndex <= 0;
        redoButton.disabled = this.currentIndex >= this.states.length - 1;
    }
}

// Initialize the diagram history
const diagramHistory = new DiagramHistory();

// Initialize the BPMN diagram
async function initializeBpmn() {
    // Load an empty BPMN diagram to start with
    const emptyBpmn = `<?xml version="1.0" encoding="UTF-8"?>
    <bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" id="Definitions_1" targetNamespace="http://bpmn.io/schema/bpmn">
      <bpmn:process id="Process_1" isExecutable="false">
        <bpmn:startEvent id="StartEvent_1"/>
      </bpmn:process>
      <bpmndi:BPMNDiagram id="BPMNDiagram_1">
        <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_1">
          <bpmndi:BPMNShape id="_BPMNShape_StartEvent_2" bpmnElement="StartEvent_1">
            <dc:Bounds x="152" y="102" width="36" height="36"/>
          </bpmndi:BPMNShape>
        </bpmndi:BPMNPlane>
      </bpmndi:BPMNDiagram>
    </bpmn:definitions>`;

    try {
        await window.modeler.importXML(emptyBpmn);
        // Adjust the view to fit the diagram
        window.modeler.get('canvas').zoom('fit-viewport');
        await updateXMLSource();
        await diagramHistory.saveState(); // Save initial state
    } catch (err) {
        console.error('Error loading BPMN diagram', err);
    }
}

// Call the initialization function
initializeBpmn();
// Replace the load button event listener with this version that handles both modern and legacy approaches
document.getElementById('load-btn').addEventListener('click', async () => {
    if (hasFileSystemAccess) {
        try {
            const [fileHandle] = await window.showOpenFilePicker({
                types: [{
                    description: 'BPMN files',
                    accept: {
                        'application/xml': ['.bpmn']
                    }
                }],
                multiple: false
            });
            
            lastFileHandle = fileHandle;
            const file = await fileHandle.getFile();
            document.getElementById('diagram-title').textContent = file.name;
            document.title = file.name + ' - BPMN.io Editor';

            const text = await file.text();
            await window.modeler.importXML(text);
            await updateXMLSource();
        } catch (err) {
            if (err.name !== 'AbortError') {
                console.error('Error selecting file:', err);
            }
        }
    } else {
        // Fallback to traditional file input
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.bpmn';
        input.onchange = async (e) => {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('diagram-title').textContent = file.name;
                document.title = file.name + ' - BPMN.io Editor';

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        await window.modeler.importXML(e.target.result);
                        await updateXMLSource();
                    } catch (err) {
                        console.error('Error loading diagram:', err);
                    }
                };
                reader.readAsText(file);
            }
        };
        input.click();
    }
});

// Replace the save button event listener with this version
document.getElementById('save-btn').addEventListener('click', async () => {
    try {
        const { xml } = await window.modeler.saveXML({ format: true });
        
        if (hasFileSystemAccess && lastFileHandle) {
            try {
                const writable = await lastFileHandle.createWritable();
                await writable.write(xml);
                await writable.close();
                document.getElementById('diagram-title').textContent = lastFileHandle.name;
                document.title = lastFileHandle.name + ' - BPMN.io Editor';
                return;
            } catch (err) {
                console.error('Error saving to last location:', err);
                // Fall through to fallback save
            }
        }
        
        // Fallback save method
        const blob = new Blob([xml], { type: 'text/xml' });
        const link = document.createElement('a');
        link.href = window.URL.createObjectURL(blob);
        
        let fileName = document.getElementById('diagram-title').textContent.trim();
        if (!fileName.toLowerCase().endsWith('.bpmn')) {
            fileName += '.bpmn';
        }
        link.download = fileName;
        document.getElementById('diagram-title').textContent = fileName;
        document.title = fileName + ' - BPMN.io Editor';
        link.click();
        
    } catch (err) {
        console.error('Error saving diagram:', err);
    }
});

// Add a fallback save function for unsupported browsers
async function fallbackSave(xml) {
    const blob = new Blob([xml], { type: 'text/xml' });
    const link = document.createElement('a');
    link.href = window.URL.createObjectURL(blob);
    
    let fileName = document.getElementById('diagram-title').textContent.trim();
    if (!fileName.toLowerCase().endsWith('.bpmn')) {
        fileName += '.bpmn';
    }
    link.download = fileName;
    link.click();
}

// Handle title editing
const titleElement = document.getElementById('diagram-title');

titleElement.addEventListener('keydown', (e) => {
    // Prevent newlines in title
    if (e.key === 'Enter') {
        e.preventDefault();
        titleElement.blur();
    }
});

titleElement.addEventListener('blur', () => {
    let title = titleElement.textContent.trim();
    if (!title) {
        title = 'Untitled Diagram';
    }
    titleElement.textContent = title;
});

// Add SVG export functionality
document.getElementById('save-svg-btn').addEventListener('click', async () => {
    try {
        const { svg } = await window.modeler.saveSVG({ format: true });
        const blob = new Blob([svg], { type: 'image/svg+xml' });
        const link = document.createElement('a');
        link.href = window.URL.createObjectURL(blob);
        
        // Use the current diagram name but with .svg extension
        let fileName = document.getElementById('diagram-title').textContent.trim();
        fileName = fileName.replace(/\.bpmn$/, ''); // Remove .bpmn if present
        fileName += '.svg';
        
        link.download = fileName;
        link.click();
    } catch (err) {
        console.error('Error exporting SVG:', err);
    }
});

// Add PNG export functionality
document.getElementById('save-png-btn').addEventListener('click', async () => {
    try {
        const { svg } = await window.modeler.saveSVG({ format: true });
        
        // Create SVG blob
        const svgBlob = new Blob([svg], { type: 'image/svg+xml' });
        const url = URL.createObjectURL(svgBlob);
        
        // Create Image from SVG
        const img = new Image();
        img.onload = () => {
            // Create canvas with proper dimensions
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size to match the SVG
            canvas.width = img.width;
            canvas.height = img.height;
            
            // Draw white background (SVG default is transparent)
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw the image
            ctx.drawImage(img, 0, 0);
            
            // Convert to PNG and download
            canvas.toBlob((blob) => {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                
                // Use the current diagram name but with .png extension
                let fileName = document.getElementById('diagram-title').textContent.trim();
                fileName = fileName.replace(/\.(bpmn|svg)$/, ''); // Remove .bpmn or .svg if present
                fileName += '.png';
                
                link.download = fileName;
                link.click();
                
                // Cleanup
                URL.revokeObjectURL(link.href);
            }, 'image/png');
            
            // Cleanup
            URL.revokeObjectURL(url);
        };
        
        img.onerror = (error) => {
            console.error('Error loading SVG for PNG conversion:', error);
        };
        
        img.src = url;
    } catch (err) {
        console.error('Error exporting PNG:', err);
    }
});

// Panel toggle functionality
document.querySelector('.panel-toggle').addEventListener('click', () => {
    const panel = document.querySelector('.right-panel');
    const canvas = document.querySelector('#canvas');
    
    panel.classList.toggle('collapsed');
    canvas.classList.toggle('full-width');
    
    // Trigger a resize event for the BPMN viewer
    window.modeler.get('canvas').zoom('fit-viewport');
});

// Add this function to handle XML updates from the source editor
async function updateCanvasFromXML() {
    const xmlSource = document.getElementById('xml-source').value;
    try {
        await window.modeler.importXML(xmlSource);
        // Don't call updateXMLSource here to avoid infinite loop
    } catch (err) {
        console.error('Error updating diagram from XML:', err);
        // Revert to previous valid XML
        await updateXMLSource();
    }
}

// Add this function to handle syntax highlighting
async function updateHighlighting(code) {
    const highlightedCode = document.querySelector('.xml-highlighted code');
    if (highlightedCode) {
        // First, remove the data-highlighted attribute
        delete highlightedCode.dataset.highlighted;
        
        // Update the content
        highlightedCode.textContent = code;
        
        // Force highlight.js to re-highlight the code
        hljs.configure({ ignoreUnescapedHTML: true });
        hljs.highlightElement(highlightedCode);
    }
}

// Modify the updateXMLSource function
async function updateXMLSource() {
    const xmlSource = document.getElementById('xml-source');
    if (document.activeElement !== xmlSource) {
        try {
            const { xml } = await window.modeler.saveXML({ format: true });
            xmlSource.value = xml;
            // Ensure the XML is properly formatted before highlighting
            const formattedXml = xml.replace(/></g, '>\n<');
            await updateHighlighting(formattedXml);
        } catch (err) {
            console.error('Error updating XML source:', err);
        }
    }
}

// Add debounce function to limit update frequency
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Modify the XML source input handler
document.getElementById('xml-source').addEventListener('input', 
    debounce(async (e) => {
        const code = e.target.value;
        // Format the XML before highlighting
        const formattedXml = code.replace(/></g, '>\n<');
        await updateHighlighting(formattedXml);
        await updateCanvasFromXML();
    }, 1000)
);

// Add scroll sync between textarea and highlighted code
document.getElementById('xml-source').addEventListener('scroll', (e) => {
    const highlighted = document.querySelector('.xml-highlighted');
    highlighted.scrollTop = e.target.scrollTop;
    highlighted.scrollLeft = e.target.scrollLeft;
});

// Modify the existing event listener for diagram changes
window.modeler.on('commandStack.changed', async () => {
    await updateXMLSource();
    await diagramHistory.saveState();
});

// Add event listeners for undo/redo buttons
document.getElementById('undo-btn').addEventListener('click', () => {
    diagramHistory.undo();
});

document.getElementById('redo-btn').addEventListener('click', () => {
    diagramHistory.redo();
});

// Add keyboard shortcuts for undo/redo
document.addEventListener('keydown', async (e) => {
    if (e.ctrlKey || e.metaKey) { // metaKey for Mac
        if (e.key === 'z' && !e.shiftKey) {
            e.preventDefault();
            await diagramHistory.undo();
        } else if ((e.key === 'y') || (e.key === 'z' && e.shiftKey)) {
            e.preventDefault();
            await diagramHistory.redo();
        }
    }
});

// Update the expand panel click handler
document.querySelector('.expand-panel').addEventListener('click', () => {
    const panel = document.querySelector('.right-panel');
    const canvas = document.querySelector('#canvas');
    const expandIcon = document.querySelector('.expand-panel i');
    
    // Toggle expanded class
    panel.classList.toggle('expanded');
    
    // Toggle the icon
    if (panel.classList.contains('expanded')) {
        expandIcon.classList.remove('bi-arrows-fullscreen');
        expandIcon.classList.add('bi-fullscreen-exit');
    } else {
        expandIcon.classList.remove('bi-fullscreen-exit');
        expandIcon.classList.add('bi-arrows-fullscreen');
    }
    
    // Make sure the panel is visible if it was collapsed
    if (panel.classList.contains('collapsed')) {
        panel.classList.remove('collapsed');
        canvas.classList.remove('full-width');
    }
    
    // Trigger a resize event for the BPMN viewer
    window.modeler.get('canvas').zoom('fit-viewport');
});

// Add keyboard shortcut for deletion
document.addEventListener('keydown', (e) => {
    if (e.key === 'Delete' || e.key === 'Backspace') {
        const selection = window.modeler.get('selection');
        const selectedElements = selection.get();
        
        if (selectedElements.length > 0) {
            e.preventDefault(); // Prevent default delete behavior
            
            // Get the context pad
            const contextPad = window.modeler.get('contextPad');
            
            // Get the delete entry from context pad
            const contextPadEntries = contextPad.getEntries(selectedElements[0]);
            const deleteEntry = contextPadEntries['delete'];
            
            // Trigger the delete action if available
            if (deleteEntry && deleteEntry.action) {
                if (typeof deleteEntry.action === 'function') {
                    deleteEntry.action(selectedElements[0]);
                } else if (typeof deleteEntry.action.click === 'function') {
                    deleteEntry.action.click(selectedElements[0]);
                }
            }
        }
    }
});

// Add clipboard functionality
document.addEventListener('keydown', (e) => {
    // Get required services
    const copyPaste = window.modeler.get('copyPaste');
    const selection = window.modeler.get('selection');
    const keyboard = window.modeler.get('keyboard');
    
    // Only handle if we're not in an input/textarea
    if (e.target.matches('input, textarea')) {
        return;
    }

    // Copy: Ctrl/Cmd + C
    if ((e.ctrlKey || e.metaKey) && e.key === 'c') {
        e.preventDefault();
        const selectedElements = selection.get();
        if (selectedElements.length > 0) {
            copyPaste.copy(selectedElements);
        }
    }
    
    // Paste: Ctrl/Cmd + V
    if ((e.ctrlKey || e.metaKey) && e.key === 'v') {
        e.preventDefault();
        // The copy-paste module handles positioning automatically
        copyPaste.paste();
    }
    
    // Cut: Ctrl/Cmd + X
    if ((e.ctrlKey || e.metaKey) && e.key === 'x') {
        e.preventDefault();
        const selectedElements = selection.get();
        if (selectedElements.length > 0) {
            copyPaste.copy(selectedElements);
            // Use the modeling service to remove the elements
            const modeling = window.modeler.get('modeling');
            modeling.removeElements(selectedElements);
        }
    }
});

// Helper function to adjust color opacity (move this outside of any other function)
function adjustColorOpacity(hex) {
    // Remove the # if present
    hex = hex.replace('#', '');
    
    // Convert to a lighter version of the same color
    const r = parseInt(hex.slice(0, 2), 16);
    const g = parseInt(hex.slice(2, 4), 16);
    const b = parseInt(hex.slice(4, 6), 16);
    
    // Make it lighter by mixing with white
    const lighterR = Math.floor(r + (255 - r) * 0.8);
    const lighterG = Math.floor(g + (255 - g) * 0.8);
    const lighterB = Math.floor(b + (255 - b) * 0.8);
    
    // Convert back to hex
    return '#' + 
        lighterR.toString(16).padStart(2, '0') +
        lighterG.toString(16).padStart(2, '0') +
        lighterB.toString(16).padStart(2, '0');
}

// Custom context pad provider for color picker
function ColorContextPadProvider(contextPad, modeling) {
    console.log('Initializing ColorContextPadProvider');
    this._contextPad = contextPad;
    this._modeling = modeling;
}

ColorContextPadProvider.$inject = [
    'contextPad',
    'modeling'
];

// Function to show color picker popup
function showColorPicker(event, element, modeling) {
    const popup = document.getElementById('color-picker-popup');
    const padPosition = event.target.getBoundingClientRect();
    
    // Position the popup near the context pad
    popup.style.left = `${padPosition.left + padPosition.width + 5}px`;
    popup.style.top = `${padPosition.top}px`;
    popup.style.display = 'block';
    
    // Handle color option clicks
    const handleColorClick = (color) => {
        if (color === 'none') {
            modeling.setColor(element, {
                stroke: null,
                fill: null
            });
        } else {
            modeling.setColor(element, {
                stroke: color,
                fill: element.type.includes('Event') ? 
                    color : adjustColorOpacity(color)
            });
        }
        popup.style.display = 'none';
    };
    
    // Add click handlers to color options
    document.querySelectorAll('.color-option').forEach(option => {
        option.onclick = () => handleColorClick(option.dataset.color);
    });
    
    // Handle "More colors" button
    document.querySelector('.more-colors').onclick = () => {
        const colorInput = document.createElement('input');
        colorInput.type = 'color';
        
        // Get current color if exists
        if (element.di && element.di.get('stroke')) {
            colorInput.value = element.di.get('stroke');
        }
        
        colorInput.style.position = 'fixed';
        colorInput.style.opacity = '0';
        document.body.appendChild(colorInput);
        
        colorInput.addEventListener('change', (e) => {
            handleColorClick(e.target.value);
            document.body.removeChild(colorInput);
        });
        
        colorInput.click();
        popup.style.display = 'none';
    };
    
    // Close popup when clicking outside
    document.addEventListener('click', function closePopup(e) {
        if (!popup.contains(e.target) && !event.target.contains(e.target)) {
            popup.style.display = 'none';
            document.removeEventListener('click', closePopup);
        }
    });
}

// Update the context pad color picker action
ColorContextPadProvider.prototype.getContextPadEntries = function(element) {
    const modeling = this._modeling;

    if (!element.waypoints) {
        return {
            'custom-color': {
                group: 'edit',
                className: 'entry custom-color bpmn-icon-custom-color',
                title: 'Change color',
                action: {
                    click: function(event, element) {
                        showColorPicker(event, element, modeling);
                    }
                }
            }
        };
    }
    return {};
};

// Wait for modeler to be initialized before registering the provider
window.modeler.on('import.done', () => {
    console.log('Registering ColorContextPadProvider');
    const contextPad = window.modeler.get('contextPad');
    const modeling = window.modeler.get('modeling');
    
    // Create and register the provider
    const colorContextPadProvider = new ColorContextPadProvider(contextPad, modeling);
    contextPad.registerProvider(colorContextPadProvider);

    console.log("contextPad", contextPad);

    // Add keyboard shortcuts initialization
    document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM loaded, initializing keyboard shortcuts');
        
        // Add keyboard shortcuts handlers
        const closeButton = document.getElementById('close-keyboard');
        if (closeButton) {
            console.log('Adding close button handler');
            closeButton.addEventListener('click', () => {
                console.log('Close button clicked');
                document.getElementById('keyboard-shortcuts').style.display = 'none';
            });
        } else {
            console.error('Close button not found');
        }

        // Add overlay click handler
        const overlay = document.getElementById('keyboard-shortcuts');
        if (overlay) {
            console.log('Adding overlay click handler');
            overlay.addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    console.log('Overlay background clicked');
                    e.currentTarget.style.display = 'none';
                }
            });
        } else {
            console.error('Keyboard shortcuts overlay not found');
        }

        // Add toggle button handler
        const toggleButton = document.getElementById('show-shortcuts');
        if (toggleButton) {
            console.log('Adding toggle button handler');
            toggleButton.addEventListener('click', () => {
                console.log('Toggle button clicked');
                toggleKeyboardShortcuts();
            });
        } else {
            console.error('Toggle button not found');
        }
    });
});

// Add multi-selection handler
window.modeler.on('selection.changed', ({ newSelection }) => {
    console.log('Selection changed:', newSelection);
    
    const multiSelectionPanel = document.getElementById('multi-selection-panel');
    const xmlPanel = document.querySelector('.panel-content:not(#multi-selection-panel)');
    
    if (newSelection.length > 1) {
        // Show multi-selection panel
        if (multiSelectionPanel) {
            multiSelectionPanel.style.display = 'block';
            if (xmlPanel) xmlPanel.style.display = 'none';
            
            // Make sure the panel is visible
            const panel = document.querySelector('.right-panel');
            if (panel.classList.contains('collapsed')) {
                panel.classList.remove('collapsed');
                document.querySelector('#canvas').classList.remove('full-width');
            }
        }
    } else {
        // Hide multi-selection panel
        if (multiSelectionPanel) {
            multiSelectionPanel.style.display = 'none';
            if (xmlPanel) xmlPanel.style.display = 'block';
        }
    }
});

// Add handlers for multi-selection actions
document.getElementById('multi-color-btn')?.addEventListener('click', () => {
    const selection = window.modeler.get('selection');
    const modeling = window.modeler.get('modeling');
    const selectedElements = selection.get();
    
    // Create color picker
    const colorInput = document.createElement('input');
    colorInput.type = 'color';
    colorInput.style.position = 'fixed';
    colorInput.style.left = '-1000px';
    colorInput.style.top = '-1000px';
    document.body.appendChild(colorInput);
    
    // Handle color selection
    colorInput.addEventListener('change', (e) => {
        const color = e.target.value;
        selectedElements.forEach(element => {
            modeling.setColor(element, {
                stroke: color,
                fill: element.type.includes('Event') ? color : adjustColorOpacity(color)
            });
        });
        document.body.removeChild(colorInput);
    });
    
    colorInput.click();
});

document.getElementById('multi-delete-btn')?.addEventListener('click', () => {
    const selection = window.modeler.get('selection');
    const modeling = window.modeler.get('modeling');
    const selectedElements = selection.get();
    
    modeling.removeElements(selectedElements);
});

// Add zoom control handlers
document.getElementById('zoom-in')?.addEventListener('click', () => {
    const zoomScroll = window.modeler.get('zoomScroll');
    zoomScroll.stepZoom(1);
});

document.getElementById('zoom-out')?.addEventListener('click', () => {
    const zoomScroll = window.modeler.get('zoomScroll');
    zoomScroll.stepZoom(-1);
});

document.getElementById('zoom-fit')?.addEventListener('click', () => {
    const canvas = window.modeler.get('canvas');
    canvas.zoom('fit-viewport');
});

// Add handlers for multi-selection copy/paste
document.getElementById('multi-copy-btn')?.addEventListener('click', () => {
    const selection = window.modeler.get('selection');
    const copyPaste = window.modeler.get('copyPaste');
    const selectedElements = selection.get();
    
    if (selectedElements.length > 0) {
        copyPaste.copy(selectedElements);
    }
});

document.getElementById('multi-paste-btn')?.addEventListener('click', () => {
    const copyPaste = window.modeler.get('copyPaste');
    copyPaste.paste();
});

// Add keyboard shortcuts overlay toggle
function toggleKeyboardShortcuts() {
    const overlay = document.getElementById('keyboard-shortcuts');
    console.log('Toggling keyboard shortcuts overlay');
    console.log('Current display:', overlay.style.display);
    overlay.style.display = overlay.style.display === 'none' ? 'flex' : 'none';
    console.log('New display:', overlay.style.display);
}

// Keep the keyboard shortcut handler at document level
document.addEventListener('keydown', (e) => {
    if (e.key === '?' && (e.ctrlKey || e.metaKey)) {
        console.log('Keyboard shortcut triggered');
        e.preventDefault();
        toggleKeyboardShortcuts();
    }
});

// Add auto-color functionality
let autoColorEnabled = false;

// Function to get most common color for element type
function getMostCommonColor(elementType) {
    const elementRegistry = window.modeler.get('elementRegistry');
    const allElements = elementRegistry.getAll();
    
    // Create a color frequency map for this element type
    const colorFrequency = {};
    
    allElements.forEach(element => {
        if (element.type === elementType && element.di && element.di.get('stroke')) {
            const color = element.di.get('stroke');
            colorFrequency[color] = (colorFrequency[color] || 0) + 1;
        }
    });
    
    // Find the most common color
    let mostCommonColor = null;
    let highestFrequency = 0;
    
    Object.entries(colorFrequency).forEach(([color, frequency]) => {
        if (frequency > highestFrequency) {
            mostCommonColor = color;
            highestFrequency = frequency;
        }
    });
    
    return mostCommonColor;
}

// Add auto-color toggle handler
document.getElementById('auto-color-toggle')?.addEventListener('change', (e) => {
    autoColorEnabled = e.target.checked;
    console.log('Auto-color toggle changed:', autoColorEnabled);
});

// Add shape create listener with delayed color application
window.modeler.on('shape.added', ({ element }) => {
    if (autoColorEnabled && element.type) {
        // Wait for the next event loop to apply color
        setTimeout(() => {
            try {
                const modeling = window.modeler.get('modeling');
                const commonColor = getMostCommonColor(element.type);
                console.log('Common color:', commonColor);
                if (commonColor) {
                    modeling.setColor(element, {
                        stroke: commonColor,
                        fill: element.type.includes('Event') ? 
                            commonColor : adjustColorOpacity(commonColor)
                    });
                }
            } catch (error) {
                console.error('Error applying auto-color:', error);
            }
        }, 0);
    }
}); 
</script>

    <!-- Add this at the bottom of the body, before the scripts -->
    <div id="keyboard-shortcuts" class="keyboard-overlay" style="display: none;">
        <div class="keyboard-content">
            <div class="keyboard-header">
                <h4>Keyboard Shortcuts</h4>
                <button class="btn btn-close" id="close-keyboard"></button>
            </div>
            <div class="shortcuts-list">
                <div class="shortcut-group">
                    <h5>General</h5>
                    <div class="shortcut-item">
                        <span class="shortcut-keys"><kbd>Ctrl</kbd> + <kbd>Z</kbd></span>
                        <span class="shortcut-desc">Undo</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-keys"><kbd>Ctrl</kbd> + <kbd>Y</kbd></span>
                        <span class="shortcut-desc">Redo</span>
                    </div>
                </div>
                <div class="shortcut-group">
                    <h5>Clipboard</h5>
                    <div class="shortcut-item">
                        <span class="shortcut-keys"><kbd>Ctrl</kbd> + <kbd>C</kbd></span>
                        <span class="shortcut-desc">Copy</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-keys"><kbd>Ctrl</kbd> + <kbd>V</kbd></span>
                        <span class="shortcut-desc">Paste</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-keys"><kbd>Ctrl</kbd> + <kbd>X</kbd></span>
                        <span class="shortcut-desc">Cut</span>
                    </div>
                </div>
                <div class="shortcut-group">
                    <h5>Tools</h5>
                    <div class="shortcut-item">
                        <span class="shortcut-keys"><kbd>L</kbd></span>
                        <span class="shortcut-desc">Lasso Tool</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-keys"><kbd>H</kbd></span>
                        <span class="shortcut-desc">Hand Tool</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-keys"><kbd>S</kbd></span>
                        <span class="shortcut-desc">Space Tool</span>
                    </div>
                    <div class="shortcut-item">
                        <span class="shortcut-keys"><kbd>C</kbd></span>
                        <span class="shortcut-desc">Global Connect</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add this after the keyboard-shortcuts div -->
    <div id="color-picker-popup" class="djs-popup color-picker" style="display: none;">
        <div class="color-options">
            <button class="color-option remove-color" data-color="none" title="Remove color">
                <i class="bi bi-x-lg"></i>
            </button>
            <button class="color-option" data-color="#90CAF9" style="background-color: #90CAF9;"></button>
            <button class="color-option" data-color="#FFCC80" style="background-color: #FFCC80;"></button>
            <button class="color-option" data-color="#A5D6A7" style="background-color: #A5D6A7;"></button>
            <button class="color-option" data-color="#EF9A9A" style="background-color: #EF9A9A;"></button>
            <button class="color-option" data-color="#CE93D8" style="background-color: #CE93D8;"></button>
            <button class="more-colors">More colours...</button>
        </div>
    </div>
</body>
</html> 